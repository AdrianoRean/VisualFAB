<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FAB Decklist Winrate Viz</title>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
</head>
<body>
  <h1>FAB Decklist Winrate Visualization</h1>
  <form id="criteria-form">
    Format: <input name="Format" value="Classic Constructed"><br>
    Rank min: <input name="RankMin" type="number" value="1"><br>
    Rank max: <input name="RankMax" type="number" value="8"><br>
    <button type="submit">Update Viz</button>
  </form>
  <div id="viz"></div>
  <script>
    async function fetchDecklists(criteria) {
      const response = await fetch('http://localhost:3000/api/decklists', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(criteria)
      });
      return response.json();
    }

    function drawViz(data) {
      d3.select("#viz").html(""); // Clear previous viz
      // Example: Bar chart of winrates by player
      const width = 600, height = 300;
      const svg = d3.select("#viz").append("svg")
        .attr("width", width).attr("height", height);

      // Example: Assume each decklist has Metadata.Player Name and Matchup.Winrate
      const winrates = data.map(d => ({
        name: d.Metadata["Player Name"],
        winrate: d.Matchup?.Winrate ?? 0
      }));

      const x = d3.scaleBand()
        .domain(winrates.map(d => d.name))
        .range([40, width-20])
        .padding(0.1);

      const y = d3.scaleLinear()
        .domain([0, d3.max(winrates, d => d.winrate) || 1])
        .range([height-40, 20]);

      svg.selectAll("rect")
        .data(winrates)
        .enter()
        .append("rect")
        .attr("x", d => x(d.name))
        .attr("y", d => y(d.winrate))
        .attr("width", x.bandwidth())
        .attr("height", d => y(0) - y(d.winrate))
        .attr("fill", "steelblue");

      svg.append("g")
        .attr("transform", `translate(0,${height-40})`)
        .call(d3.axisBottom(x).tickFormat(d => d).tickSizeOuter(0))
        .selectAll("text")
        .attr("transform", "rotate(-45)")
        .style("text-anchor", "end");

      svg.append("g")
        .attr("transform", `translate(40,0)`)
        .call(d3.axisLeft(y));
    }

    // Handle form submission
    document.getElementById('criteria-form').onsubmit = async function(e) {
      e.preventDefault();
      const form = e.target;
      const criteria = {
        Format: form.Format.value,
        Rank: {min: Number(form.RankMin.value), max: Number(form.RankMax.value)}
      };
      const data = await fetchDecklists(criteria);
      drawViz(data);
    };

    // Initial load
    //document.getElementById('criteria-form').dispatchEvent(new Event('submit'));
  </script>
</body>
</html>